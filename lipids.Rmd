---
title: "lipids"
author: "jmm"
date: "8/19/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Analysis of bird visits to plants 

We analyzed the data following the Bayesian hierarchical approach developed by Ovaskainen el al. [2017](https://onlinelibrary.wiley.com/doi/abs/10.1111/ele.12757). We modelled the number of visits from different bird genera to the focal plant genera at each site using a Negative Binomial distribution where the expected number of visits was a linear function of the lipid content of the fruits from each plant genera (log link), and with plant and site random effects:

$$
\begin{aligned}
& y_{i,j,k} \sim \text{NB} \left(\mu_{i,j,k}, \phi  \right) \\
& \log{\mu_{i,j,k}} = \beta_{0,i} + \beta_{1,i} \times lipids_{j} + \epsilon_j + \nu_k \\
\end{aligned}
$$

where $y_{i,j,k}$ is the observed number of visits of bird genus $i$ to plant genus $j$ on site $k$, and $\epsilon_j$ and $\nu_k$ are plant and site random effects.

We modelled these intercept and slopes as a function of two traits (1) proportion of fruits in their diet and (2) log-transformed body size. To control for phylogenetic relationship in the responses of the birds to lipid content, we included in the model phylogenetic relationships among the bird genera. 

The genus-specific parameters are combined into a matrix $\mathbf{\Theta}$) that has as many rows as genera and as many columns as regression parameters (two in our case). To determine the way in which genus respond to environmental factors depend on their traits and phylogenetic relationships, we vectorize the matrix $\mathbf{\Theta}$ to  $\mathbf{\theta} = vec(\mathbf{\Theta})$, and model it using a multivariate normal distribution as

$$
\theta \sim \text{N} \left(\mathbf{m}, \Sigma \otimes \left[ \rho \mathbf{C} + \left(1 - \rho \right) \mathbf{I}_{n_g} \right] \right)
$$

here the vector $\mathbf{m} = \text{vec}(\mathbf{M})$ is the vectorized version of the matrix $\mathbf{M}$ that holds the expected parameters for each genus based on species traits. That is, $\mathbf{M} = \mathbf{T} \mathbf{Z}$, where $\mathbf{T}$ is the design matrix of bird traits and $\mathbf{Z}$ is a matrix of coefficients. The first column of $\mathbf{T}$ is made of ones to allow for variation independent of traits. The second and third columns contain scaled frugivory and log body mass respectively. The two-by-two varianceâ€“covariance matrix $\Sigma$ above models the genus-specific deviations around the expectation based on species traits, and $\otimes$ is the Kronecker (outer) product. The matrix $\mathbf{C}$ is a phylogenetic correlation matrix among bird genera derived from a concensus tree obtained from [BirdTree.org](http://birdtree.org/). The matrix $\mathbf{I}_{n_g}$ is the identity matrix of dimension equal to the number of bird genera $n_g$, and the parameter $0 \leq \rho \leq 1$ measures the strength of the phylogenetic signal.

As random effects, we included the site and the plant genera. We assumed for both of these levels a Gaussian decaying covariance function, where the distance matrix for sites was based on Euclidian distance and the distance matrix for plants was based on their phylogenetic distance. The over-dispersion parameter of the Negative Binomial was estimated as a free parameter. 


Load the phylogenetic data:

```{r}
library(ape)
filo <- read.nexus("data/output_tree_sep_2018_consensus_only.nex")
filop <- read.nexus("data/Tree_with_second_taxa_from_Tomas_geneious_nexus_25Sep2018.nex")

```

Get a correlation matrix from the bird phylogenetic tree, and sort birds and re-arrange phylogenetic correlation to match the order of bird ids in the data

```{r}
CC = vcv(filo, corr = TRUE)
tmp <- dimnames(CC)
ids <- as.numeric(as.factor(tmp[[1]]))

C <- matrix(NA, ncol(CC), ncol(CC))
for(i in 1:ncol(CC)){
  for(j in 1:ncol(CC)){
    C[ids[i], ids[j]] <- CC[i,j]
  }
}
```

# cophenetic distance among plants
coP <- cophenetic(filop)

tmp <- dimnames(coP)
idsp <- as.numeric(as.factor(tmp[[1]]))

DistP <- matrix(NA, ncol(coP), ncol(coP))
for(i in 1:ncol(coP)){
  for(j in 1:ncol(coP)){
    DistP[idsp[i],idsp[j]] <- coP[i,j]
  }
}


Load the visitation data
```{r}
datos <- read.csv("data/up_data_genus_ll.csv", header = TRUE, nrows = 2378)
```
